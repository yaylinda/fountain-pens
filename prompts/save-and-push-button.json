{
  "$schema": "../schemas/prompt.schema.json",
  "id": "save-and-push-button",
  "title": "Add Save Button with Git Push and Diff Preview",
  "description": "Add a Save button that pushes data changes to GitHub with a diff preview dialog",
  "authors": [
    { "name": "Sean", "type": "human" },
    { "name": "Claude (Cursor)", "type": "model" }
  ],
  "createdAt": "2026-01-30T02:30:00Z",
  "status": "ready",
  "tags": ["feature", "ux", "git", "data-persistence"],
  "content": "## Feature: Save Button with Git Push and Diff Preview\n\n### Context\nThe fountain-pens app stores data in JSON files (`src/data/inks.json`, `src/data/pens.json`, `src/data/refillLog.json`). Currently, when Linda makes edits, the JSON files are updated locally but she has to manually run git commands to push changes to GitHub for backup. We want to automate this with a nice UX.\n\n### Requirements\n\n#### 1. Save Button in Header\n- Add a \"Save\" button to the right of the title \"Fountain Pen & Ink Manager\" in the AppBar\n- The button should be **disabled** by default\n- The button becomes **enabled** when ANY data mutation occurs (add/edit/delete of inks, pens, or refill logs)\n- After a successful save, the button returns to **disabled** state\n- Use an appropriate MUI icon (e.g., CloudUpload, Save, or Backup)\n\n#### 2. Dirty State Tracking\n- Track a global \"dirty\" state that indicates unsaved changes exist\n- This state should be set to `true` whenever:\n  - An ink is added, updated, or deleted\n  - A pen is added, updated, or deleted  \n  - A refill log is added, updated, or deleted\n- The state should be set to `false` after a successful push\n- Consider using React Context or a simple state management approach\n\n#### 3. Save Dialog with Diff Preview\nWhen the Save button is clicked, show a MUI Dialog that:\n- Has a title like \"Review Changes Before Saving\"\n- Shows a **diff view** of all modified files (inks.json, pens.json, refillLog.json)\n  - The diff should be fetched from a new backend API endpoint\n  - Display the diff in a readable format (could use a simple pre/code block with + and - lines, or a proper diff viewer component)\n  - Color-code additions (green) and deletions (red)\n- Has a \"Cancel\" button that closes the dialog without saving\n- Has a \"Confirm & Push\" button at the bottom\n\n#### 4. Push Process and Feedback\nWhen \"Confirm & Push\" is clicked:\n- Show a loading spinner (MUI CircularProgress) with text like \"Pushing to GitHub...\"\n- Disable both buttons during the push\n- Call a new backend API endpoint that performs the git add/commit/push\n\n**On Success:**\n- Close the dialog\n- Show a **confetti animation** to celebrate (use a library like `canvas-confetti` or `react-confetti`)\n- Set dirty state to false (button becomes disabled)\n- Show a brief success toast/snackbar\n\n**On Failure:**\n- Stay on the dialog\n- Show the **exact error output** from the git command in a scrollable code block\n- Allow the user to try again or cancel\n- Include the full stderr/stdout so programmers can debug\n\n#### 5. Backend API Endpoints (server.js)\n\nAdd two new endpoints:\n\n**GET /api/git/diff**\n- Returns the current `git diff` output for the data files\n- Response: `{ diff: string, hasChanges: boolean }`\n- If no changes, `diff` can be empty and `hasChanges` is false\n\n**POST /api/git/push**  \n- Performs: `git add src/data/*.json && git commit -m \"Data update - <timestamp>\" && git push origin main`\n- Response on success: `{ success: true, message: string }`\n- Response on failure: `{ success: false, error: string, stdout: string, stderr: string }`\n- The commit message should include a timestamp\n\n### Technical Notes\n- The data directory inside the container is mounted from `./src/data` on the host\n- The host directory (`/home/fountain-pens/src/data/`) is a git repository with push credentials configured\n- Git commands need to run on the **host**, not inside the container\n- Since the container can't directly run git, we need to either:\n  - Option A: Mount the `.git` directory and install git in the container\n  - Option B: Have the container write a \"push requested\" flag file that the host's update script detects\n  - Option C: The container can exec git commands if we mount the docker socket (not recommended)\n  - **Recommended: Option A** - Mount `.git` and add git to the Dockerfile\n\n### Implementation Approach\n1. Update Dockerfile to install git\n2. Update docker-compose.yml to also mount `.git` directory\n3. Add git config for user.email and user.name in container startup\n4. Add the two API endpoints to server.js\n5. Create a DirtyStateContext in React for tracking unsaved changes\n6. Update dataService.ts to set dirty state on mutations\n7. Add SaveButton component to App.tsx header\n8. Create SaveDialog component with diff preview and push logic\n9. Add confetti library and success animation\n10. Test the full flow\n\n### Acceptance Criteria\n- [ ] Save button appears in header, disabled by default\n- [ ] Save button enables after any data edit\n- [ ] Clicking Save shows diff preview dialog\n- [ ] Diff is readable with color-coded additions/deletions\n- [ ] Confirm & Push shows spinner during operation\n- [ ] Success shows confetti and closes dialog\n- [ ] Failure shows exact error, allows retry\n- [ ] After success, button is disabled again\n- [ ] Works in production (on fountain-pens.contrived.com)"
}
